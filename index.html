<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>ConstructAI - Procurement ERP</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        :root {
            --primary: #2563eb; --dark: #0f172a; --bg: #f8fafc; --surface: #ffffff;
            --text-main: #334155; --text-light: #64748b; --border: #e2e8f0;
            --success: #10b981; --warning: #f59e0b; --danger: #ef4444;
        }
        
        * { box-sizing: border-box; outline: none; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text-main); margin: 0; display: flex; height: 100vh; overflow: hidden; }

        /* LAYOUT */
        .sidebar { width: 260px; background: var(--dark); color: white; display: flex; flex-direction: column; flex-shrink: 0; }
        .brand { padding: 25px; font-size: 1.3rem; font-weight: 800; border-bottom: 1px solid #1e293b; display: flex; align-items: center; gap: 10px; }
        .nav-item { padding: 15px 25px; cursor: pointer; color: #94a3b8; display: flex; align-items: center; gap: 12px; transition: 0.2s; font-weight: 500; border-left: 3px solid transparent;}
        .nav-item:hover { background: rgba(255,255,255,0.05); color: white; }
        .nav-item.active { background: #1e293b; color: white; border-left-color: var(--primary); }
        
        .main { flex: 1; padding: 30px; overflow-y: auto; display: flex; flex-direction: column; }

        /* COMPONENTS */
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; }
        .page-title { font-size: 1.8rem; font-weight: 800; color: var(--dark); }
        
        .stat-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: var(--surface); padding: 20px; border-radius: 12px; border: 1px solid var(--border); box-shadow: 0 2px 4px rgba(0,0,0,0.03); }
        .stat-val { font-size: 1.6rem; font-weight: 800; margin-top: 5px; color: var(--dark); }
        .stat-lbl { font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.5px; color: var(--text-light); font-weight: 700; }

        /* LISTS */
        .list-container { display: flex; flex-direction: column; gap: 12px; }
        .list-item { background: var(--surface); padding: 20px; border: 1px solid var(--border); border-radius: 10px; display: flex; justify-content: space-between; align-items: center; transition: all 0.2s; }
        .list-item:hover { border-color: var(--primary); box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
        
        /* BADGES & BUTTONS */
        .badge { padding: 4px 10px; border-radius: 20px; font-size: 0.75rem; font-weight: 700; text-transform: uppercase; }
        .badge-Lead { background: #e0f2fe; color: #0284c7; }
        .badge-Active { background: #fef3c7; color: #b45309; }
        .badge-Done { background: #dcfce7; color: #166534; }

        .btn { padding: 10px 18px; border-radius: 8px; border: 1px solid transparent; cursor: pointer; font-weight: 600; display: inline-flex; align-items: center; gap: 8px; transition: 0.2s; font-size: 0.9rem; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-outline { background: white; border-color: #cbd5e1; color: var(--text-main); }
        .btn-danger { background: #fee2e2; color: var(--danger); }
        .btn-sm { padding: 6px 12px; font-size: 0.8rem; }

        /* MODALS */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(15, 23, 42, 0.6); backdrop-filter: blur(2px); z-index: 1000; justify-content: center; align-items: center; }
        .modal { background: var(--surface); padding: 30px; width: 600px; border-radius: 16px; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25); max-height: 90vh; overflow-y: auto; }
        
        input, select { width: 100%; padding: 12px; margin: 8px 0 20px 0; border: 1px solid #cbd5e1; border-radius: 8px; }
        label { font-weight: 600; font-size: 0.85rem; color: var(--text-main); }

        /* EXPENSE TABLE (Inside Modal) */
        .expense-table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 0.9rem; }
        .expense-table th { text-align: left; border-bottom: 2px solid var(--border); padding: 8px; color: var(--text-light); }
        .expense-table td { border-bottom: 1px solid var(--border); padding: 8px; }
        
        .view-section { display: none; }
        .view-section.active { display: block; animation: fade 0.3s; }
        @keyframes fade { from { opacity: 0; } to { opacity: 1; } }
        
        /* Toast */
        #toast-container { position: fixed; bottom: 24px; right: 24px; z-index: 2000; display: flex; flex-direction: column; gap: 10px; }
        .toast { background: var(--dark); color: white; padding: 12px 20px; border-radius: 8px; animation: slideIn 0.3s; display: flex; gap: 10px; }
        @keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }
    </style>
</head>
<body>

<div class="sidebar">
    <div class="brand"><i class="fas fa-building"></i> ConstructAI <span style="opacity:0.5; font-size:0.8em; margin-left:auto;">ERP</span></div>
    <div class="nav-item active" onclick="nav('dashboard', this)"><i class="fas fa-chart-line"></i> Dashboard</div>
    <div class="nav-item" onclick="nav('projects', this)"><i class="fas fa-hard-hat"></i> Projects</div>
    <div class="nav-item" onclick="nav('catalog', this)"><i class="fas fa-book-open"></i> Vendor Catalog</div>
    <div class="nav-item" onclick="nav('team', this)"><i class="fas fa-users"></i> Workforce</div>
    <div class="nav-item" onclick="nav('activity', this)"><i class="fas fa-history"></i> Audit Log</div>
</div>

<div class="main">
    
    <div id="view-dashboard" class="view-section active">
        <div class="header"><div class="page-title">Financial Overview</div></div>
        
        <div class="stat-grid">
            <div class="stat-card">
                <div class="stat-lbl">Total Revenue (Pipeline)</div>
                <div class="stat-val" style="color:var(--primary)" id="kpi-rev">$0</div>
            </div>
            <div class="stat-card">
                <div class="stat-lbl">Total Vendor Spend</div>
                <div class="stat-val" style="color:var(--danger)" id="kpi-cost">$0</div>
            </div>
            <div class="stat-card">
                <div class="stat-lbl">Net Profit Estimate</div>
                <div class="stat-val" style="color:var(--success)" id="kpi-profit">$0</div>
            </div>
            <div class="stat-card">
                <div class="stat-lbl">Active Projects</div>
                <div class="stat-val" id="kpi-active">0</div>
            </div>
        </div>

        <div style="display:grid; grid-template-columns: 2fr 1fr; gap: 20px; height: 350px;">
            <div class="stat-card"><canvas id="finChart"></canvas></div>
            <div class="stat-card"><canvas id="statusChart"></canvas></div>
        </div>
    </div>

    <div id="view-projects" class="view-section">
        <div class="header">
            <div class="page-title">Job Management</div>
            <div style="display:flex; gap: 10px;">
                <input type="text" class="search-bar" placeholder="Search jobs..." onkeyup="renderProjects(this.value)">
                
                <input type="file" id="csvInput" accept=".csv" style="display:none" onchange="handleCSV(this)">
                <button class="btn btn-outline" onclick="document.getElementById('csvInput').click()">
                    <i class="fas fa-file-csv"></i> Import Leads
                </button>
                
                <button class="btn btn-primary" onclick="openProjectModal()"><i class="fas fa-plus"></i> New Job</button>
            </div>
        </div>
        <div id="projectList" class="list-container"></div>
    </div>

    <div id="view-catalog" class="view-section">
        <div class="header">
            <div class="page-title">Vendor Price Book</div>
            <div style="display:flex; gap: 10px;">
                <input type="text" class="search-bar" placeholder="Search materials..." onkeyup="renderCatalog(this.value)">
                <button class="btn btn-primary" onclick="openCatalogModal()"><i class="fas fa-plus"></i> Add Material</button>
            </div>
        </div>
        <div id="catalogList" class="list-container"></div>
    </div>

    <div id="view-team" class="view-section">
        <div class="header">
            <div class="page-title">Workforce</div>
            <button class="btn btn-primary" onclick="openTeamModal()"><i class="fas fa-user-plus"></i> Hire</button>
        </div>
        <div id="teamList" class="list-container"></div>
    </div>

    <div id="view-activity" class="view-section">
        <div class="header"><div class="page-title">Audit Log</div></div>
        <div id="auditLog" style="background:white; border:1px solid var(--border); border-radius:12px;"></div>
    </div>
</div>

<div id="toast-container"></div>

<div id="modalProject" class="modal-overlay">
    <div class="modal">
        <h2 style="margin-top:0">Project Details</h2>
        <input type="hidden" id="p_id">
        <label>Project Name</label><input type="text" id="p_name">
        <label>Revenue / Contract Value ($)</label><input type="number" id="p_val">
        
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px;">
            <div><label>Status</label><select id="p_status"><option>Lead</option><option>Active</option><option>Done</option></select></div>
            <div><label>Foreman</label><select id="p_foreman"></select></div>
        </div>

        <div style="display:flex; gap:10px;">
            <button class="btn btn-primary" style="flex:1" onclick="saveProject()">Save Record</button>
            <button class="btn btn-outline" style="flex:1" onclick="closeModals()">Cancel</button>
        </div>
    </div>
</div>

<div id="modalExpense" class="modal-overlay">
    <div class="modal" style="width:700px;">
        <h2 style="margin-top:0"><i class="fas fa-shopping-cart"></i> Material Procurement</h2>
        <p style="color:var(--text-light)">Add materials from vendor catalog to this project.</p>
        <input type="hidden" id="exp_pid">

        <div style="background:#f1f5f9; padding:15px; border-radius:8px; margin-bottom:20px;">
            <div style="display:grid; grid-template-columns: 2fr 1fr 1fr; gap:10px; align-items:end;">
                <div>
                    <label>Select Material (Vendor)</label>
                    <select id="exp_mat"></select>
                </div>
                <div>
                    <label>Quantity</label>
                    <input type="number" id="exp_qty" placeholder="0" style="margin-bottom:0">
                </div>
                <button class="btn btn-primary" onclick="addExpenseItem()">+ Add to Bill</button>
            </div>
        </div>

        <h3>Project Bill of Materials</h3>
        <table class="expense-table">
            <thead><tr><th>Material</th><th>Vendor</th><th>Qty</th><th>Cost</th><th>Date</th></tr></thead>
            <tbody id="expenseBody"></tbody>
        </table>
        
        <div style="margin-top:20px; text-align:right; font-weight:bold; font-size:1.1rem;">
            Total Spend: <span id="exp_total" style="color:var(--danger)">$0.00</span>
        </div>

        <div style="margin-top:20px;">
            <button class="btn btn-outline" style="width:100%" onclick="closeModals()">Close</button>
        </div>
    </div>
</div>

<div id="modalCatalog" class="modal-overlay">
    <div class="modal">
        <h2 style="margin-top:0">Vendor Catalog Item</h2>
        <input type="hidden" id="c_id">
        <label>Item Name</label><input type="text" id="c_name">
        <label>Vendor Name</label><input type="text" id="c_vendor">
        <label>Unit Cost ($)</label><input type="number" id="c_cost">
        <label>Unit Type</label><input type="text" id="c_unit" placeholder="e.g. per bag, per ft">
        <div style="display:flex; gap:10px;">
            <button class="btn btn-primary" style="flex:1" onclick="saveCatalog()">Save Item</button>
            <button class="btn btn-outline" style="flex:1" onclick="closeModals()">Cancel</button>
        </div>
    </div>
</div>

<div id="modalTeam" class="modal-overlay">
    <div class="modal">
        <h2 style="margin-top:0">Employee</h2>
        <input type="hidden" id="t_id">
        <label>Name</label><input type="text" id="t_name">
        <label>Role</label><input type="text" id="t_role">
        <div style="display:flex; gap:10px;">
            <button class="btn btn-primary" style="flex:1" onclick="saveTeam()">Save</button>
            <button class="btn btn-outline" style="flex:1" onclick="closeModals()">Cancel</button>
        </div>
    </div>
</div>

<script>
    // --- ERP DATA STORE ---
    const db = {
        projects: JSON.parse(localStorage.getItem('erp4_proj')) || [],
        catalog: JSON.parse(localStorage.getItem('erp4_cat')) || [], // Renamed from Inventory
        team: JSON.parse(localStorage.getItem('erp4_team')) || [],
        logs: JSON.parse(localStorage.getItem('erp4_logs')) || []
    };

    let charts = {};

    // --- INIT ---
    // Seed Data if empty
    if(db.catalog.length === 0) {
        db.catalog.push({id:1, name:'2x4 Lumber', vendor:'Home Depot', cost:6.50, unit:'piece'});
        db.catalog.push({id:2, name:'Concrete Mix', vendor:'Lowes', cost:8.00, unit:'bag'});
        db.catalog.push({id:3, name:'Copper Wire', vendor:'City Electric', cost:120.00, unit:'spool'});
    }

    refreshAll();

    // --- NAVIGATION ---
    function nav(view, el) {
        document.querySelectorAll('.view-section').forEach(e=>e.classList.remove('active'));
        document.getElementById('view-'+view).classList.add('active');
        document.querySelectorAll('.nav-item').forEach(e=>e.classList.remove('active'));
        el.classList.add('active');
        if(view==='dashboard') renderDashboard();
        if(view==='activity') renderLogs();
    }

    // --- 1. CSV IMPORT (EDITABLE REVENUE) ---
    function handleCSV(input) {
        const file = input.files[0];
        if(!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const rows = e.target.result.split('\n');
                let count = 0;
                for(let i=1; i<rows.length; i++) {
                    if(!rows[i].trim()) continue;
                    const cols = rows[i].split(',');
                    
                    const name = cols[1] ? cols[1].replace(/"/g,'').trim() : "Imported Lead";
                    const val = cols[2] ? parseFloat(cols[2]) : 0;

                    db.projects.push({
                        id: Date.now()+i,
                        name: name,
                        value: val, // Editable revenue
                        status: 'Lead',
                        foremanId: "",
                        expenses: [] // New: Array for multiple materials
                    });
                    count++;
                }
                notify(`Imported ${count} leads. You can now edit them.`);
                log(`Imported CSV with ${count} records`);
                saveAll();
                input.value = "";
            } catch(err) { notify("Error parsing CSV", "error"); }
        };
        reader.readAsText(file);
    }

    // --- 2. PROJECT LOGIC ---
    function renderProjects(filter="") {
        const list = document.getElementById('projectList');
        list.innerHTML = "";
        
        db.projects.filter(p=>p.name.toLowerCase().includes(filter.toLowerCase())).forEach(p => {
            const foreman = db.team.find(t=>t.id==p.foremanId)?.name || "Unassigned";
            
            // Calculate Total Spend
            const totalSpend = p.expenses ? p.expenses.reduce((a,b) => a + b.total, 0) : 0;
            const margin = p.value > 0 ? Math.round(((p.value - totalSpend)/p.value)*100) : 0;

            list.innerHTML += `
                <div class="list-item">
                    <div style="flex:1">
                        <span class="badge badge-${p.status}">${p.status}</span>
                        <div style="font-weight:bold; font-size:1.1rem; margin-top:5px;">${p.name}</div>
                        <small style="color:var(--text-light)"><i class="fas fa-user"></i> ${foreman}</small>
                    </div>
                    <div style="text-align:right; min-width:150px; margin:0 20px;">
                        <div style="color:var(--primary); font-weight:bold;">Rev: $${p.value.toLocaleString()}</div>
                        <div style="font-size:0.85rem; color:var(--danger)">Spend: $${totalSpend.toLocaleString()}</div>
                        <div style="font-size:0.8rem; color:${margin>0?'var(--success)':'var(--text-light)'}">Margin: ${margin}%</div>
                    </div>
                    <div style="display:flex; gap:8px;">
                        <button class="btn btn-outline btn-sm" onclick="openExpenseModal(${p.id})" title="Purchase Materials"><i class="fas fa-shopping-cart"></i> Buy</button>
                        <button class="btn btn-outline btn-sm" onclick="openProjectModal(${p.id})" title="Edit Details"><i class="fas fa-pen"></i></button>
                        <button class="btn btn-danger btn-sm" onclick="delProject(${p.id})"><i class="fas fa-trash"></i></button>
                    </div>
                </div>
            `;
        });
    }

    function openProjectModal(id=null) {
        document.getElementById('modalProject').style.display='flex';
        const fSelect = document.getElementById('p_foreman');
        fSelect.innerHTML = '<option value="">-- Select --</option>';
        db.team.forEach(t => fSelect.innerHTML += `<option value="${t.id}">${t.name}</option>`);

        if(id) {
            const p = db.projects.find(x=>x.id==id);
            document.getElementById('p_id').value = p.id;
            document.getElementById('p_name').value = p.name;
            document.getElementById('p_val').value = p.value; // Revenue is editable
            document.getElementById('p_status').value = p.status;
            document.getElementById('p_foreman').value = p.foremanId;
        } else {
            document.getElementById('p_id').value = "NEW";
            document.getElementById('p_name').value = "";
            document.getElementById('p_val').value = "";
        }
    }

    function saveProject() {
        const id = document.getElementById('p_id').value;
        const name = document.getElementById('p_name').value;
        const val = Number(document.getElementById('p_val').value);
        const status = document.getElementById('p_status').value;
        const fid = document.getElementById('p_foreman').value;

        if(!name) return notify("Name required","error");

        if(id==="NEW") {
            db.projects.push({id:Date.now(), name, value:val, status, foremanId:fid, expenses:[]});
            log(`Created job: ${name}`);
        } else {
            const p = db.projects.find(x=>x.id==id);
            p.name=name; p.value=val; p.status=status; p.foremanId=fid;
            log(`Updated job: ${name}`);
        }
        saveAll(); closeModals();
    }

    // --- 3. PROCUREMENT & EXPENSES (MULTIPLE MATERIALS) ---
    function openExpenseModal(pid) {
        document.getElementById('modalExpense').style.display='flex';
        document.getElementById('exp_pid').value = pid;
        
        // Populate Vendor Catalog Dropdown
        const sel = document.getElementById('exp_mat');
        sel.innerHTML = '';
        db.catalog.forEach(c => {
            sel.innerHTML += `<option value="${c.id}">${c.name} (${c.vendor}) - $${c.cost}/${c.unit}</option>`;
        });

        renderExpenseTable(pid);
    }

    function addExpenseItem() {
        const pid = document.getElementById('exp_pid').value;
        const matId = document.getElementById('exp_mat').value;
        const qty = Number(document.getElementById('exp_qty').value);

        if(qty <= 0) return notify("Invalid Quantity", "error");

        const proj = db.projects.find(p => p.id == pid);
        const item = db.catalog.find(c => c.id == matId);

        if(!proj.expenses) proj.expenses = [];

        const totalCost = item.cost * qty;

        proj.expenses.push({
            id: Date.now(),
            itemName: item.name,
            vendor: item.vendor,
            unitCost: item.cost,
            qty: qty,
            total: totalCost,
            date: new Date().toLocaleDateString()
        });

        log(`Purchased ${qty} ${item.name} for ${proj.name}`);
        notify(`Added to bill: $${totalCost}`);
        saveAll(); // Save to DB
        renderExpenseTable(pid); // Refresh the table inside modal
        document.getElementById('exp_qty').value = ""; // Clear input
    }

    function renderExpenseTable(pid) {
        const proj = db.projects.find(p => p.id == pid);
        const tbody = document.getElementById('expenseBody');
        tbody.innerHTML = "";
        
        let grandTotal = 0;

        if(proj.expenses && proj.expenses.length > 0) {
            proj.expenses.forEach(e => {
                grandTotal += e.total;
                tbody.innerHTML += `
                    <tr>
                        <td>${e.itemName}</td>
                        <td>${e.vendor}</td>
                        <td>${e.qty}</td>
                        <td>$${e.total.toLocaleString()}</td>
                        <td>${e.date}</td>
                    </tr>
                `;
            });
        } else {
            tbody.innerHTML = "<tr><td colspan='5' style='text-align:center; color:#999;'>No materials purchased yet.</td></tr>";
        }

        document.getElementById('exp_total').innerText = "$" + grandTotal.toLocaleString();
    }

    // --- 4. CATALOG & TEAM ---
    function renderCatalog(filter="") {
        const list = document.getElementById('catalogList');
        list.innerHTML = "";
        db.catalog.filter(c=>c.name.toLowerCase().includes(filter.toLowerCase())).forEach(c => {
            list.innerHTML += `
                <div class="list-item">
                    <div>
                        <div style="font-weight:bold;">${c.name}</div>
                        <small>${c.vendor}</small>
                    </div>
                    <div style="font-weight:bold; color:var(--primary)">$${c.cost} / ${c.unit}</div>
                    <div style="display:flex; gap:8px;">
                        <button class="btn btn-outline btn-sm" onclick="openCatalogModal(${c.id})"><i class="fas fa-pen"></i></button>
                        <button class="btn btn-danger btn-sm" onclick="delCatalog(${c.id})"><i class="fas fa-trash"></i></button>
                    </div>
                </div>
            `;
        });
    }

    function openCatalogModal(id=null) {
        document.getElementById('modalCatalog').style.display='flex';
        if(id) {
            const c = db.catalog.find(x=>x.id==id);
            document.getElementById('c_id').value=c.id; document.getElementById('c_name').value=c.name; document.getElementById('c_vendor').value=c.vendor; document.getElementById('c_cost').value=c.cost; document.getElementById('c_unit').value=c.unit;
        } else { document.getElementById('c_id').value="NEW"; document.getElementById('c_name').value=""; document.getElementById('c_vendor').value=""; }
    }
    function saveCatalog() {
        const id = document.getElementById('c_id').value;
        const name=document.getElementById('c_name').value; const vend=document.getElementById('c_vendor').value; const cost=Number(document.getElementById('c_cost').value); const unit=document.getElementById('c_unit').value;
        if(id=="NEW") { db.catalog.push({id:Date.now(), name, vendor:vend, cost, unit}); }
        else { const c=db.catalog.find(x=>x.id==id); c.name=name; c.vendor=vend; c.cost=cost; c.unit=unit; }
        saveAll(); closeModals();
    }

    function renderTeam() {
        const list = document.getElementById('teamList');
        list.innerHTML = "";
        db.team.forEach(t => {
            list.innerHTML += `
                <div class="list-item">
                    <div><strong>${t.name}</strong><br><small>${t.role}</small></div>
                    <div><button class="btn btn-outline btn-sm" onclick="openTeamModal(${t.id})">Edit</button> <button class="btn btn-danger btn-sm" onclick="delTeam(${t.id})">Fire</button></div>
                </div>
            `;
        });
    }
    function openTeamModal(id=null) {
        document.getElementById('modalTeam').style.display='flex';
        if(id) { const t=db.team.find(x=>x.id==id); document.getElementById('t_id').value=t.id; document.getElementById('t_name').value=t.name; document.getElementById('t_role').value=t.role; }
        else { document.getElementById('t_id').value="NEW"; document.getElementById('t_name').value=""; }
    }
    function saveTeam() {
        const id=document.getElementById('t_id').value; const name=document.getElementById('t_name').value; const role=document.getElementById('t_role').value;
        if(id=="NEW") db.team.push({id:Date.now(), name, role});
        else { const t=db.team.find(x=>x.id==id); t.name=name; t.role=role; }
        saveAll(); closeModals();
    }

    // --- DASHBOARD ---
    function renderDashboard() {
        const totalRev = db.projects.reduce((a,b)=>a+(b.value||0),0);
        const totalSpend = db.projects.reduce((a,b)=> a + (b.expenses ? b.expenses.reduce((x,y)=>x+y.total,0) : 0), 0);
        const margin = totalRev > 0 ? Math.round(((totalRev-totalSpend)/totalRev)*100) : 0;

        document.getElementById('kpi-rev').innerText = "$" + totalRev.toLocaleString();
        document.getElementById('kpi-cost').innerText = "$" + totalSpend.toLocaleString();
        document.getElementById('kpi-profit').innerText = "$" + (totalRev-totalSpend).toLocaleString();
        document.getElementById('kpi-active').innerText = db.projects.filter(p=>p.status==='Active').length;

        renderCharts(totalRev, totalSpend);
    }

    function renderCharts(rev, spend) {
        const ctx1 = document.getElementById('finChart');
        const ctx2 = document.getElementById('statusChart');
        if(charts.fin) charts.fin.destroy();
        if(charts.stat) charts.stat.destroy();

        charts.fin = new Chart(ctx1, {
            type: 'bar',
            data: { labels:['Financials'], datasets:[{label:'Revenue', data:[rev], backgroundColor:'#2563eb'}, {label:'Spend', data:[spend], backgroundColor:'#ef4444'}] },
            options: {responsive:true, maintainAspectRatio:false}
        });
        
        const s = {Lead:0, Active:0, Done:0}; db.projects.forEach(p=>s[p.status]++);
        charts.stat = new Chart(ctx2, {
            type: 'doughnut', data: { labels:['Lead','Active','Done'], datasets:[{data:[s.Lead, s.Active, s.Done], backgroundColor:['#e0f2fe','#f59e0b','#10b981']}] },
            options: {responsive:true, maintainAspectRatio:false}
        });
    }

    function renderLogs() {
        const l = document.getElementById('auditLog'); l.innerHTML="";
        [...db.logs].reverse().forEach(log => l.innerHTML+=`<div style="padding:12px; border-bottom:1px solid #eee; font-size:0.9rem;"><span style="color:#999; margin-right:10px;">${new Date(log.date).toLocaleTimeString()}</span> ${log.msg}</div>`);
    }

    // --- UTILS ---
    function log(msg) { db.logs.push({date:Date.now(), msg}); }
    function notify(msg, type='success') {
        const c = document.getElementById('toast-container'); const d = document.createElement('div'); d.className=`toast ${type}`; d.innerText=msg; c.appendChild(d);
        setTimeout(()=>d.remove(), 3000);
    }
    function closeModals() { document.querySelectorAll('.modal-overlay').forEach(e=>e.style.display='none'); }
    function delProject(id) { if(confirm("Delete?")) { db.projects=db.projects.filter(x=>x.id!=id); saveAll(); } }
    function delCatalog(id) { if(confirm("Delete?")) { db.catalog=db.catalog.filter(x=>x.id!=id); saveAll(); } }
    function delTeam(id) { if(confirm("Delete?")) { db.team=db.team.filter(x=>x.id!=id); saveAll(); } }
    function saveAll() {
        localStorage.setItem('erp4_proj', JSON.stringify(db.projects));
        localStorage.setItem('erp4_cat', JSON.stringify(db.catalog));
        localStorage.setItem('erp4_team', JSON.stringify(db.team));
        localStorage.setItem('erp4_logs', JSON.stringify(db.logs));
        refreshAll();
    }
    function refreshAll() { renderProjects(); renderCatalog(); renderTeam(); }

</script>
</body>
</html>