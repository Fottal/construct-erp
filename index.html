<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>ConstructAI - Cloud ERP</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <style>
        /* (SAME STYLING AS BEFORE - COMPRESSED FOR BREVITY) */
        :root { --primary: #2563eb; --dark: #0f172a; --bg: #f8fafc; --surface: #ffffff; --text: #334155; --border: #e2e8f0; --success: #10b981; --danger: #ef4444; }
        * { box-sizing: border-box; outline: none; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); margin: 0; display: flex; height: 100vh; overflow: hidden; }
        .sidebar { width: 260px; background: var(--dark); color: white; display: flex; flex-direction: column; flex-shrink:0; }
        .brand { padding: 25px; font-size: 1.3rem; font-weight: 800; border-bottom: 1px solid #1e293b; display: flex; align-items: center; gap: 10px; }
        .nav-item { padding: 15px 25px; cursor: pointer; color: #94a3b8; display: flex; gap: 12px; transition: 0.2s; font-weight: 500; border-left: 3px solid transparent; }
        .nav-item:hover, .nav-item.active { background: #1e293b; color: white; border-left-color: var(--primary); }
        .main { flex: 1; padding: 30px; overflow-y: auto; display: flex; flex-direction: column; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; }
        .page-title { font-size: 1.8rem; font-weight: 800; color: var(--dark); }
        .stat-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: var(--surface); padding: 20px; border-radius: 12px; border: 1px solid var(--border); }
        .stat-val { font-size: 1.6rem; font-weight: 800; margin-top: 5px; color: var(--dark); }
        .stat-lbl { font-size: 0.75rem; text-transform: uppercase; font-weight: 700; color: #64748b; }
        .list-container { display: flex; flex-direction: column; gap: 12px; }
        .list-item { background: var(--surface); padding: 20px; border: 1px solid var(--border); border-radius: 10px; display: flex; justify-content: space-between; align-items: center; transition: 0.2s; }
        .list-item:hover { border-color: var(--primary); box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
        .badge { padding: 4px 10px; border-radius: 20px; font-size: 0.75rem; font-weight: 700; text-transform: uppercase; }
        .badge-Lead { background: #e0f2fe; color: #0284c7; } .badge-Active { background: #fef3c7; color: #b45309; } .badge-Done { background: #dcfce7; color: #166534; }
        .btn { padding: 10px 18px; border-radius: 8px; border: 1px solid transparent; cursor: pointer; font-weight: 600; display: inline-flex; align-items: center; gap: 8px; font-size: 0.9rem; }
        .btn-primary { background: var(--primary); color: white; } 
        .btn-outline { background: white; border-color: #cbd5e1; color: var(--text); }
        .btn-danger { background: #fee2e2; color: var(--danger); }
        .search-bar { padding: 12px; border: 1px solid var(--border); border-radius: 8px; width: 300px; }
        .view-section { display: none; } .view-section.active { display: block; animation: fade 0.3s; } @keyframes fade { from { opacity: 0; } to { opacity: 1; } }
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(15, 23, 42, 0.6); z-index: 1000; justify-content: center; align-items: center; }
        .modal { background: var(--surface); padding: 30px; width: 600px; border-radius: 16px; max-height: 90vh; overflow-y: auto; }
        input, select { width: 100%; padding: 12px; margin: 8px 0 20px 0; border: 1px solid #cbd5e1; border-radius: 8px; }
        .expense-table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 0.9rem; }
        .expense-table th { text-align: left; border-bottom: 2px solid var(--border); padding: 8px; } .expense-table td { border-bottom: 1px solid var(--border); padding: 8px; }
        #connection-status { position: fixed; bottom: 10px; left: 10px; font-size: 0.8rem; color: #10b981; z-index: 2000; display: flex; align-items: center; gap: 5px; }
    </style>
</head>
<body>

<div class="sidebar">
    <div class="brand"><i class="fas fa-cloud"></i> ConstructAI <span style="opacity:0.5; font-size:0.8em; margin-left:auto;">CLOUD</span></div>
    <div class="nav-item active" onclick="nav('dashboard', this)"><i class="fas fa-chart-line"></i> Dashboard</div>
    <div class="nav-item" onclick="nav('projects', this)"><i class="fas fa-hard-hat"></i> Projects</div>
    <div class="nav-item" onclick="nav('catalog', this)"><i class="fas fa-book-open"></i> Catalog</div>
    <div class="nav-item" onclick="nav('team', this)"><i class="fas fa-users"></i> Workforce</div>
    <div class="nav-item" onclick="nav('activity', this)"><i class="fas fa-history"></i> Audit Log</div>
</div>

<div class="main">
    <div id="loading" style="position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); text-align:center;">
        <i class="fas fa-circle-notch fa-spin fa-3x" style="color:var(--primary)"></i>
        <p>Syncing with Cloud...</p>
    </div>

    <div id="app-content" style="display:none; width:100%; height:100%;">
        
        <div id="view-dashboard" class="view-section active">
            <div class="header"><div class="page-title">Cloud Dashboard</div></div>
            <div class="stat-grid">
                <div class="stat-card">
                    <div class="stat-lbl">Pipeline Revenue</div>
                    <div class="stat-val" style="color:var(--primary)" id="kpi-rev">$0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-lbl">Material Expense</div>
                    <div class="stat-val" style="color:var(--danger)" id="kpi-cost">$0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-lbl">Net Profit</div>
                    <div class="stat-val" style="color:var(--success)" id="kpi-profit">$0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-lbl">Active Jobs</div>
                    <div class="stat-val" id="kpi-active">0</div>
                </div>
            </div>
            <div style="height: 350px; background: white; padding: 20px; border-radius: 12px; border: 1px solid var(--border);">
                <canvas id="finChart"></canvas>
            </div>
        </div>

        <div id="view-projects" class="view-section">
            <div class="header">
                <div class="page-title">Projects</div>
                <div style="display:flex; gap: 10px;">
                    <input type="text" class="search-bar" placeholder="Search..." onkeyup="renderProjects(this.value)">
                    <button class="btn btn-primary" onclick="openProjectModal()"><i class="fas fa-plus"></i> New Job</button>
                </div>
            </div>
            <div id="projectList" class="list-container"></div>
        </div>

        <div id="view-catalog" class="view-section">
            <div class="header">
                <div class="page-title">Vendor Catalog</div>
                <button class="btn btn-primary" onclick="openCatalogModal()"><i class="fas fa-plus"></i> Add Item</button>
            </div>
            <div id="catalogList" class="list-container"></div>
        </div>

        <div id="view-team" class="view-section">
            <div class="header">
                <div class="page-title">Workforce</div>
                <button class="btn btn-primary" onclick="openTeamModal()"><i class="fas fa-user-plus"></i> Hire</button>
            </div>
            <div id="teamList" class="list-container"></div>
        </div>

        <div id="view-activity" class="view-section">
            <div class="header"><div class="page-title">Cloud Audit Log</div></div>
            <div id="auditLog" style="background:white; border:1px solid var(--border); border-radius:12px;"></div>
        </div>
    </div>
</div>

<div id="connection-status"><i class="fas fa-wifi"></i> Connected to Firebase</div>

<div id="modalProject" class="modal-overlay">
    <div class="modal">
        <h2>Project Details</h2>
        <input type="hidden" id="p_id">
        <label>Name</label><input type="text" id="p_name">
        <label>Revenue ($)</label><input type="number" id="p_val">
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px;">
            <div><label>Status</label><select id="p_status"><option>Lead</option><option>Active</option><option>Done</option></select></div>
            <div><label>Foreman</label><select id="p_foreman"></select></div>
        </div>
        <div style="display:flex; gap:10px; margin-top:20px;">
            <button class="btn btn-primary" style="flex:1" onclick="saveProject()">Save</button>
            <button class="btn btn-outline" style="flex:1" onclick="closeModals()">Cancel</button>
        </div>
    </div>
</div>

<div id="modalExpense" class="modal-overlay">
    <div class="modal" style="width:700px;">
        <h2>Material Procurement</h2>
        <input type="hidden" id="exp_pid">
        <div style="background:#f1f5f9; padding:15px; border-radius:8px; margin-bottom:20px; display:grid; grid-template-columns: 2fr 1fr 1fr; gap:10px; align-items:end;">
            <div><label>Material</label><select id="exp_mat"></select></div>
            <div><label>Qty</label><input type="number" id="exp_qty" placeholder="0" style="margin-bottom:0"></div>
            <button class="btn btn-primary" onclick="addExpenseItem()">+ Add</button>
        </div>
        <h3>Bill of Materials</h3>
        <table class="expense-table"><thead><tr><th>Item</th><th>Qty</th><th>Cost</th></tr></thead><tbody id="expenseBody"></tbody></table>
        <div style="margin-top:20px;"><button class="btn btn-outline" style="width:100%" onclick="closeModals()">Close</button></div>
    </div>
</div>

<div id="modalCatalog" class="modal-overlay"><div class="modal"><h2>Catalog Item</h2><input type="hidden" id="c_id"><label>Name</label><input type="text" id="c_name"><label>Vendor</label><input type="text" id="c_vendor"><label>Cost ($)</label><input type="number" id="c_cost"><label>Unit</label><input type="text" id="c_unit"><div style="display:flex; gap:10px;"><button class="btn btn-primary" style="flex:1" onclick="saveCatalog()">Save</button><button class="btn btn-outline" style="flex:1" onclick="closeModals()">Cancel</button></div></div></div>
<div id="modalTeam" class="modal-overlay"><div class="modal"><h2>Employee</h2><input type="hidden" id="t_id"><label>Name</label><input type="text" id="t_name"><label>Role</label><input type="text" id="t_role"><div style="display:flex; gap:10px;"><button class="btn btn-primary" style="flex:1" onclick="saveTeam()">Save</button><button class="btn btn-outline" style="flex:1" onclick="closeModals()">Cancel</button></div></div></div>

<script>
    // --- 1. FIREBASE CONFIGURATION --- 
    // ðŸ”´ REPLACE THE OBJECT BELOW WITH YOUR OWN FROM FIREBASE CONSOLE ðŸ”´
    const firebaseConfig = {
        apiKey: "AIzaSyA2HNjITt0civU2SJ4I40XxdnWxryQRDO4",
        authDomain: "construct-erp.firebaseapp.com",
        databaseURL: "https://construct-erp-default-rtdb.firebaseio.com",
        projectId: "construct-erp",
        storageBucket: "construct-erp.firebasestorage.app",
        messagingSenderId: "737357744238",
        appId: "1:737357744238:web:0942d58665f1709278be7f"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();

    // --- 2. DATA STATE (In-Memory) ---
    // We don't use localStorage anymore. We keep data in RAM, synced with Cloud.
    let db = { projects: [], catalog: [], team: [], logs: [] };
    let chart = null;

    // --- 3. CLOUD SYNC (THE MAGIC) ---
    // This function runs AUTOMATICALLY whenever data changes in the cloud
    database.ref().on('value', (snapshot) => {
        const cloudData = snapshot.val();
        
        if (cloudData) {
            // Convert Cloud Objects (IDs are keys) back to Arrays for our app
            db.projects = cloudData.projects ? Object.values(cloudData.projects) : [];
            db.catalog = cloudData.catalog ? Object.values(cloudData.catalog) : [];
            db.team = cloudData.team ? Object.values(cloudData.team) : [];
            db.logs = cloudData.logs ? Object.values(cloudData.logs) : [];
        } else {
            // New database? Seed it.
            seedData();
        }

        // Hide loader, show app
        document.getElementById('loading').style.display = 'none';
        document.getElementById('app-content').style.display = 'block';
        
        refreshAll(); // Update the UI
    });

    function seedData() {
        // Only runs if database is empty
        const initialCatalog = [
            {id:1, name:'2x4 Lumber', vendor:'Home Depot', cost:6.50, unit:'pc'},
            {id:2, name:'Concrete Mix', vendor:'Lowes', cost:8.00, unit:'bag'}
        ];
        const initialTeam = [{id:1, name:'Mike Foreman', role:'Site Lead'}];
        
        // Save to Cloud
        database.ref('catalog').set(arrayToObject(initialCatalog));
        database.ref('team').set(arrayToObject(initialTeam));
    }

    // Helper: Firebase likes Objects, we like Arrays. This converts Array -> Object
    function arrayToObject(arr) {
        const obj = {};
        arr.forEach(item => obj[item.id] = item);
        return obj;
    }

    // --- 4. WRITING TO CLOUD ---
    // Instead of localStorage.setItem, we use database.ref().set()
    function saveToCloud() {
        database.ref('projects').set(arrayToObject(db.projects));
        database.ref('catalog').set(arrayToObject(db.catalog));
        database.ref('team').set(arrayToObject(db.team));
        database.ref('logs').set(arrayToObject(db.logs));
    }

    // --- 5. UI LOGIC (Similar to before, but triggers saveToCloud) ---

    function renderProjects(filter="") {
        const list = document.getElementById('projectList'); list.innerHTML="";
        db.projects.filter(p=>p.name.toLowerCase().includes(filter.toLowerCase())).forEach(p => {
            const foreman = db.team.find(t=>t.id==p.foremanId)?.name || "Unassigned";
            const totalSpend = p.expenses ? p.expenses.reduce((a,b)=>a+b.total,0) : 0;
            const margin = p.value>0 ? Math.round(((p.value-totalSpend)/p.value)*100) : 0;

            list.innerHTML += `
                <div class="list-item">
                    <div style="flex:1">
                        <span class="badge badge-${p.status}">${p.status}</span>
                        <div style="font-weight:bold; font-size:1.1rem;">${p.name}</div>
                        <small style="color:#64748b">${foreman}</small>
                    </div>
                    <div style="text-align:right; margin:0 20px;">
                        <div style="color:var(--primary); font-weight:bold;">$${p.value.toLocaleString()}</div>
                        <div style="font-size:0.8rem; color:var(--danger)">-$${totalSpend.toLocaleString()}</div>
                        <div style="font-size:0.8rem; color:${margin>0?'#10b981':'#ef4444'}">${margin}% Margin</div>
                    </div>
                    <div>
                        <button class="btn btn-outline btn-sm" onclick="openExpenseModal(${p.id})"><i class="fas fa-shopping-cart"></i></button>
                        <button class="btn btn-outline btn-sm" onclick="openProjectModal(${p.id})"><i class="fas fa-pen"></i></button>
                        <button class="btn btn-danger btn-sm" onclick="delProject(${p.id})"><i class="fas fa-trash"></i></button>
                    </div>
                </div>`;
        });
    }

    function saveProject() {
        const id = document.getElementById('p_id').value;
        const name = document.getElementById('p_name').value;
        const val = Number(document.getElementById('p_val').value);
        const status = document.getElementById('p_status').value;
        const fid = document.getElementById('p_foreman').value;

        if(id==="NEW") {
            db.projects.push({id:Date.now(), name, value:val, status, foremanId:fid, expenses:[]});
            log(`Created ${name}`);
        } else {
            const p = db.projects.find(x=>x.id==id);
            p.name=name; p.value=val; p.status=status; p.foremanId=fid;
            log(`Updated ${name}`);
        }
        saveToCloud(); closeModals();
    }

    // ... (Standard Renderers for Catalog/Team same as previous version) ...
    function renderCatalog(f="") { const l=document.getElementById('catalogList'); l.innerHTML=""; db.catalog.filter(c=>c.name.toLowerCase().includes(f)).forEach(c=>l.innerHTML+=`<div class="list-item"><div><strong>${c.name}</strong><br><small>${c.vendor}</small></div><div>$${c.cost}/${c.unit}</div><div><button class="btn btn-outline btn-sm" onclick="openCatalogModal(${c.id})">Edit</button></div></div>`); }
    function renderTeam() { const l=document.getElementById('teamList'); l.innerHTML=""; db.team.forEach(t=>l.innerHTML+=`<div class="list-item"><div><strong>${t.name}</strong><br><small>${t.role}</small></div><div><button class="btn btn-outline btn-sm" onclick="openTeamModal(${t.id})">Edit</button></div></div>`); }
    function renderLogs() { const l=document.getElementById('auditLog'); l.innerHTML=""; [...db.logs].reverse().forEach(lg=>l.innerHTML+=`<div style="padding:10px; border-bottom:1px solid #eee; font-size:0.9rem;"><span style="color:#999">${new Date(lg.date).toLocaleTimeString()}</span> ${lg.msg}</div>`); }

    // Procurement Logic
    function openExpenseModal(pid) {
        document.getElementById('modalExpense').style.display='flex'; document.getElementById('exp_pid').value=pid;
        const sel = document.getElementById('exp_mat'); sel.innerHTML='';
        db.catalog.forEach(c => sel.innerHTML+=`<option value="${c.id}">${c.name} ($${c.cost})</option>`);
        renderExpenses(pid);
    }
    function addExpenseItem() {
        const pid=document.getElementById('exp_pid').value; const mid=document.getElementById('exp_mat').value; const qty=Number(document.getElementById('exp_qty').value);
        const proj=db.projects.find(p=>p.id==pid); const item=db.catalog.find(c=>c.id==mid);
        if(!proj.expenses) proj.expenses=[];
        proj.expenses.push({id:Date.now(), name:item.name, cost:item.cost, qty, total:item.cost*qty});
        log(`Bought ${item.name} for ${proj.name}`);
        saveToCloud(); renderExpenses(pid);
    }
    function renderExpenses(pid) {
        const proj=db.projects.find(p=>p.id==pid); const tbody=document.getElementById('expenseBody'); tbody.innerHTML="";
        if(proj.expenses) proj.expenses.forEach(e=>tbody.innerHTML+=`<tr><td>${e.name}</td><td>${e.qty}</td><td>$${e.total}</td></tr>`);
    }

    // Dashboard & Chart
    function renderDashboard() {
        const rev = db.projects.reduce((a,b)=>a+(b.value||0),0);
        const cost = db.projects.reduce((a,b)=>a+(b.expenses?b.expenses.reduce((x,y)=>x+y.total,0):0),0);
        document.getElementById('kpi-rev').innerText="$"+rev.toLocaleString();
        document.getElementById('kpi-cost').innerText="$"+cost.toLocaleString();
        document.getElementById('kpi-profit').innerText="$"+(rev-cost).toLocaleString();
        document.getElementById('kpi-active').innerText=db.projects.filter(p=>p.status=='Active').length;
        
        const ctx = document.getElementById('finChart');
        if(chart) chart.destroy();
        chart = new Chart(ctx, { type:'bar', data:{labels:['Finance'], datasets:[{label:'Rev', data:[rev], backgroundColor:'#2563eb'},{label:'Cost', data:[cost], backgroundColor:'#ef4444'}]}, options:{maintainAspectRatio:false}});
    }

    // Boilerplate Modals/Utils
    function nav(v,el){ document.querySelectorAll('.view-section').forEach(x=>x.classList.remove('active')); document.getElementById('view-'+v).classList.add('active'); document.querySelectorAll('.nav-item').forEach(x=>x.classList.remove('active')); el.classList.add('active'); if(v=='dashboard') renderDashboard(); }
    function openProjectModal(id=null) { document.getElementById('modalProject').style.display='flex'; const s=document.getElementById('p_foreman'); s.innerHTML='<option value="">--</option>'; db.team.forEach(t=>s.innerHTML+=`<option value="${t.id}">${t.name}</option>`); if(id){const p=db.projects.find(x=>x.id==id); document.getElementById('p_id').value=p.id; document.getElementById('p_name').value=p.name; document.getElementById('p_val').value=p.value; document.getElementById('p_status').value=p.status; document.getElementById('p_foreman').value=p.foremanId;} else {document.getElementById('p_id').value="NEW"; document.getElementById('p_name').value="";} }
    function openCatalogModal(id=null) { document.getElementById('modalCatalog').style.display='flex'; if(id){const c=db.catalog.find(x=>x.id==id); document.getElementById('c_id').value=c.id; document.getElementById('c_name').value=c.name; document.getElementById('c_vendor').value=c.vendor; document.getElementById('c_cost').value=c.cost; document.getElementById('c_unit').value=c.unit;} else {document.getElementById('c_id').value="NEW";} }
    function saveCatalog() { const id=document.getElementById('c_id').value; const name=document.getElementById('c_name').value; const vend=document.getElementById('c_vendor').value; const cost=Number(document.getElementById('c_cost').value); const unit=document.getElementById('c_unit').value; if(id=="NEW") db.catalog.push({id:Date.now(), name, vendor:vend, cost, unit}); else {const c=db.catalog.find(x=>x.id==id); c.name=name; c.vendor=vend; c.cost=cost; c.unit=unit;} saveToCloud(); closeModals(); }
    function openTeamModal(id=null) { document.getElementById('modalTeam').style.display='flex'; if(id){const t=db.team.find(x=>x.id==id); document.getElementById('t_id').value=t.id; document.getElementById('t_name').value=t.name; document.getElementById('t_role').value=t.role;} else {document.getElementById('t_id').value="NEW";} }
    function saveTeam() { const id=document.getElementById('t_id').value; const name=document.getElementById('t_name').value; const role=document.getElementById('t_role').value; if(id=="NEW") db.team.push({id:Date.now(), name, role}); else {const t=db.team.find(x=>x.id==id); t.name=name; t.role=role;} saveToCloud(); closeModals(); }
    function delProject(id) { if(confirm("Delete?")) { db.projects=db.projects.filter(x=>x.id!=id); saveToCloud(); } }
    function closeModals() { document.querySelectorAll('.modal-overlay').forEach(e=>e.style.display='none'); }
    function log(msg) { db.logs.push({date:Date.now(), msg}); }
    function refreshAll() { renderProjects(); renderCatalog(); renderTeam(); renderDashboard(); renderLogs(); }

</script>
</body>
</html>
