<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>ConstructAI - Commercial Suite</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <style>
        :root {
            --primary: #2563eb; --dark: #0f172a; --bg: #f1f5f9; --surface: #ffffff;
            --text: #334155; --border: #e2e8f0; 
            --success: #10b981; --danger: #ef4444; --warning: #f59e0b;
        }
        * { box-sizing: border-box; outline: none; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); margin: 0; display: flex; height: 100vh; overflow: hidden; }

        /* NAVIGATION */
        .sidebar { width: 260px; background: var(--dark); color: white; display: flex; flex-direction: column; flex-shrink:0; }
        .brand { padding: 25px; font-size: 1.2rem; font-weight: 800; border-bottom: 1px solid #1e293b; display: flex; align-items: center; gap: 10px; letter-spacing: -0.5px; }
        .nav-menu { flex: 1; padding-top: 10px; }
        .nav-item { padding: 12px 25px; cursor: pointer; color: #94a3b8; display: flex; gap: 12px; align-items: center; transition: 0.2s; font-weight: 500; border-left: 3px solid transparent; }
        .nav-item:hover { background: rgba(255,255,255,0.05); color: white; }
        .nav-item.active { background: #1e293b; color: white; border-left-color: var(--primary); }

        /* MAIN LAYOUT */
        .main { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
        .header { padding: 20px 30px; background: var(--surface); border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .page-title { font-size: 1.5rem; font-weight: 800; color: var(--dark); }
        .content-area { flex: 1; padding: 30px; overflow-y: auto; }

        /* STATS CARDS */
        .stat-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: var(--surface); padding: 20px; border-radius: 12px; border: 1px solid var(--border); box-shadow: 0 2px 4px rgba(0,0,0,0.03); }
        .stat-val { font-size: 1.8rem; font-weight: 800; margin-top: 5px; color: var(--dark); }
        .stat-lbl { font-size: 0.75rem; text-transform: uppercase; font-weight: 700; color: #64748b; }

        /* LIST STYLES */
        .list-container { display: flex; flex-direction: column; gap: 10px; }
        .list-item { background: var(--surface); padding: 18px; border: 1px solid var(--border); border-radius: 10px; display: flex; justify-content: space-between; align-items: center; transition: 0.2s; }
        .list-item:hover { border-color: var(--primary); box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
        
        .badge { padding: 4px 10px; border-radius: 20px; font-size: 0.75rem; font-weight: 700; text-transform: uppercase; }
        .badge-Lead { background: #e0f2fe; color: #0284c7; } 
        .badge-Scheduled { background: #fef3c7; color: #b45309; } 
        .badge-InProgress { background: #f3e8ff; color: #7e22ce; }
        .badge-Done { background: #dcfce7; color: #166534; }

        /* BUTTONS */
        .btn { padding: 10px 16px; border-radius: 8px; border: 1px solid transparent; cursor: pointer; font-weight: 600; display: inline-flex; align-items: center; gap: 8px; font-size: 0.9rem; transition: 0.2s; }
        .btn-primary { background: var(--primary); color: white; } .btn-primary:hover { background: #1d4ed8; }
        .btn-outline { background: white; border-color: #cbd5e1; color: var(--text); } .btn-outline:hover { border-color: var(--text); }
        .btn-danger { background: #fee2e2; color: var(--danger); }
        .btn-sm { padding: 6px 12px; font-size: 0.8rem; }

        /* CALENDAR OVERRIDES */
        #calendar { background: white; padding: 20px; border-radius: 12px; border: 1px solid var(--border); height: 600px; }
        .fc-event { cursor: pointer; border: none; padding: 3px; }

        /* UTILS */
        .view-section { display: none; } .view-section.active { display: block; animation: fade 0.3s; } @keyframes fade { from { opacity: 0; } to { opacity: 1; } }
        .search-bar { padding: 10px 15px; border: 1px solid var(--border); border-radius: 8px; width: 250px; }
        
        /* TOAST */
        #toast-container { position: fixed; bottom: 24px; right: 24px; z-index: 2000; display: flex; flex-direction: column; gap: 10px; }
        .toast { background: var(--dark); color: white; padding: 12px 20px; border-radius: 8px; animation: slideIn 0.3s; display: flex; gap: 10px; align-items: center; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); }
        .toast.error { border-left: 4px solid var(--danger); } .toast.success { border-left: 4px solid var(--success); }
        @keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }

        /* MODALS */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(15, 23, 42, 0.5); backdrop-filter: blur(2px); z-index: 1000; justify-content: center; align-items: center; }
        .modal { background: var(--surface); padding: 30px; width: 550px; border-radius: 16px; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25); max-height: 90vh; overflow-y: auto; }
        input, select, textarea { width: 100%; padding: 12px; margin: 8px 0 20px 0; border: 1px solid #cbd5e1; border-radius: 8px; font-family: inherit; }
        
        .row-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
    </style>
</head>
<body>

<div class="sidebar">
    <div class="brand"><i class="fas fa-hard-hat"></i> JobMaster <span style="opacity:0.5; font-size:0.8em; margin-left:auto;">PRO</span></div>
    <div class="nav-menu">
        <div class="nav-item active" onclick="nav('dashboard', this)"><i class="fas fa-chart-pie"></i> Dashboard</div>
        <div class="nav-item" onclick="nav('calendar', this)"><i class="fas fa-calendar-alt"></i> Schedule</div>
        <div class="nav-item" onclick="nav('projects', this)"><i class="fas fa-clipboard-list"></i> Jobs & Leads</div>
        <div class="nav-item" onclick="nav('catalog', this)"><i class="fas fa-tags"></i> Price Book</div>
        <div class="nav-item" onclick="nav('team', this)"><i class="fas fa-users"></i> Crew</div>
    </div>
    <div style="padding: 20px; font-size: 0.8rem; opacity: 0.5; margin-top: auto;" id="connection-status"><i class="fas fa-circle"></i> Connecting...</div>
</div>

<div class="main">
    <div class="header">
        <div class="page-title" id="page-title">Dashboard</div>
        <div style="display:flex; gap:10px;">
            <button class="btn btn-outline" onclick="document.getElementById('csvInput').click()"><i class="fas fa-file-import"></i> Import CSV</button>
            <button class="btn btn-primary" onclick="openProjectModal()"><i class="fas fa-plus"></i> New Job</button>
            <input type="file" id="csvInput" accept=".csv" style="display:none" onchange="handleCSV(this)">
        </div>
    </div>

    <div class="content-area">
        <div id="view-dashboard" class="view-section active">
            <div class="stat-grid">
                <div class="stat-card">
                    <div class="stat-lbl">Pipeline Value</div>
                    <div class="stat-val" style="color:var(--primary)" id="kpi-rev">$0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-lbl">Jobs Scheduled</div>
                    <div class="stat-val" style="color:var(--warning)" id="kpi-scheduled">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-lbl">Jobs Completed</div>
                    <div class="stat-val" style="color:var(--success)" id="kpi-done">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-lbl">Material Spend</div>
                    <div class="stat-val" style="color:var(--danger)" id="kpi-cost">$0</div>
                </div>
            </div>
            <div style="height:300px; background:white; padding:20px; border-radius:12px; border:1px solid var(--border);">
                <canvas id="finChart"></canvas>
            </div>
        </div>

        <div id="view-calendar" class="view-section">
            <div id="calendar"></div>
        </div>

        <div id="view-projects" class="view-section">
            <input type="text" class="search-bar" placeholder="Search client, address..." onkeyup="renderProjects(this.value)" style="margin-bottom:20px;">
            <div id="projectList" class="list-container"></div>
        </div>

        <div id="view-catalog" class="view-section">
            <button class="btn btn-primary" style="margin-bottom:20px;" onclick="openCatalogModal()">Add Item</button>
            <div id="catalogList" class="list-container"></div>
        </div>

        <div id="view-team" class="view-section">
            <button class="btn btn-primary" style="margin-bottom:20px;" onclick="openTeamModal()">Add Crew Member</button>
            <div id="teamList" class="list-container"></div>
        </div>
    </div>
</div>

<div id="toast-container"></div>

<div id="modalProject" class="modal-overlay">
    <div class="modal">
        <h2 style="margin-top:0">Job Details</h2>
        <input type="hidden" id="p_id">
        
        <label>Client / Project Name</label>
        <input type="text" id="p_name" placeholder="e.g. Smith Residence">

        <label>Service Address</label>
        <div style="display:flex; gap:10px;">
            <input type="text" id="p_address" placeholder="123 Main St">
            <button class="btn btn-outline" onclick="openMap()" style="height:42px; margin-top:8px;"><i class="fas fa-map-marker-alt"></i></button>
        </div>

        <div class="row-2">
            <div><label>Contract Value ($)</label><input type="number" id="p_val"></div>
            <div><label>Status</label>
                <select id="p_status">
                    <option value="Lead">Lead</option>
                    <option value="Scheduled">Scheduled</option>
                    <option value="InProgress">In Progress</option>
                    <option value="Done">Done</option>
                </select>
            </div>
        </div>

        <div class="row-2" style="background:#f8fafc; padding:10px; border-radius:8px; border:1px solid #e2e8f0; margin-bottom:20px;">
            <div><label>Start Date</label><input type="date" id="p_start"></div>
            <div><label>End Date</label><input type="date" id="p_end"></div>
        </div>

        <label>Assign Crew Lead</label>
        <select id="p_foreman"></select>

        <div style="display:flex; gap:10px;">
            <button class="btn btn-primary" style="flex:1" onclick="saveProject()">Save Job</button>
            <button class="btn btn-outline" style="flex:1" onclick="closeModals()">Cancel</button>
        </div>
    </div>
</div>

<div id="modalCatalog" class="modal-overlay"><div class="modal"><h2>Item</h2><input type="hidden" id="c_id"><label>Name</label><input type="text" id="c_name"><label>Vendor</label><input type="text" id="c_vendor"><label>Cost</label><input type="number" id="c_cost"><button class="btn btn-primary" onclick="saveCatalog()">Save</button> <button class="btn btn-outline" onclick="closeModals()">Cancel</button></div></div>
<div id="modalTeam" class="modal-overlay"><div class="modal"><h2>Crew</h2><input type="hidden" id="t_id"><label>Name</label><input type="text" id="t_name"><label>Role</label><input type="text" id="t_role"><button class="btn btn-primary" onclick="saveTeam()">Save</button> <button class="btn btn-outline" onclick="closeModals()">Cancel</button></div></div>

<script>
    // --- 1. FIREBASE CONFIG (PASTE YOURS HERE) ---
    const firebaseConfig = {
        apiKey: "AIzaSyA2HNjITt0civU2SJ4I40XxdnWxryQRDO4",
        authDomain: "construct-erp.firebaseapp.com",
        databaseURL: "https://construct-erp-default-rtdb.firebaseio.com",
        projectId: "construct-erp",
        storageBucket: "construct-erp.firebasestorage.app",
        messagingSenderId: "737357744238",
        appId: "1:737357744238:web:0942d58665f1709278be7f"
    };

    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();
    const connectedEl = document.getElementById('connection-status');

    // --- 2. APP STATE ---
    let db = { projects: [], catalog: [], team: [] };
    let calendar; 
    let chart;

    // --- 3. INITIALIZATION ---
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize FullCalendar
        var calendarEl = document.getElementById('calendar');
        calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: 'dayGridMonth',
            headerToolbar: { left: 'prev,next today', center: 'title', right: 'dayGridMonth,timeGridWeek' },
            height: '100%',
            events: [] // Will be populated from DB
        });
        calendar.render();

        // Connect to Firebase
        database.ref().on('value', (snap) => {
            const val = snap.val();
            if(val) {
                db.projects = val.projects ? Object.values(val.projects) : [];
                db.catalog = val.catalog ? Object.values(val.catalog) : [];
                db.team = val.team ? Object.values(val.team) : [];
            }
            connectedEl.innerHTML = '<i class="fas fa-wifi" style="color:#10b981"></i> Cloud Synced';
            refreshUI();
        });
    });

    function refreshUI() {
        renderProjects();
        renderCatalog();
        renderTeam();
        renderDashboard();
        updateCalendarEvents();
    }

    // --- 4. SCHEDULING & CONFLICT ENGINE ---
    function updateCalendarEvents() {
        const events = db.projects
            .filter(p => p.start && p.status !== 'Lead' && p.status !== 'Done')
            .map(p => ({
                title: p.name + (p.foremanName ? ` (${p.foremanName})` : ''),
                start: p.start,
                end: p.end ? new Date(new Date(p.end).getTime() + 86400000).toISOString().slice(0,10) : p.start, // Add 1 day for FullCalendar exclusivity
                backgroundColor: getColor(p.status),
                borderColor: getColor(p.status)
            }));
        
        calendar.removeAllEvents();
        calendar.addEventSource(events);
    }

    function checkConflict(foremanId, start, end, currentId) {
        if (!foremanId || !start || !end) return false;
        
        // Check if this foreman is busy on these dates in OTHER projects
        const conflict = db.projects.find(p => {
            if (p.id == currentId || p.status === 'Done' || p.status === 'Lead') return false; // Ignore self, leads, and done
            if (p.foremanId !== foremanId) return false; // Different person

            // Date Overlap Logic
            const pStart = new Date(p.start); const pEnd = new Date(p.end);
            const nStart = new Date(start); const nEnd = new Date(end);
            return (nStart <= pEnd && nEnd >= pStart);
        });
        return conflict;
    }

    function getColor(status) {
        if(status === 'Scheduled') return '#f59e0b';
        if(status === 'InProgress') return '#7e22ce';
        return '#2563eb';
    }

    // --- 5. PROJECT MANAGEMENT ---
    function saveProject() {
        const id = document.getElementById('p_id').value;
        const name = document.getElementById('p_name').value;
        const val = Number(document.getElementById('p_val').value);
        const status = document.getElementById('p_status').value;
        const fid = document.getElementById('p_foreman').value;
        const start = document.getElementById('p_start').value;
        const end = document.getElementById('p_end').value;
        const addr = document.getElementById('p_address').value;

        if(!name) return notify("Project Name Required", "error");

        // ðŸ›‘ CONFLICT CHECK ðŸ›‘
        if (status === 'Scheduled' || status === 'InProgress') {
            const conflict = checkConflict(fid, start, end, id);
            if(conflict) {
                return notify(`CONFLICT: ${conflict.foremanName} is already on "${conflict.name}" during these dates!`, "error");
            }
        }

        const foremanName = db.team.find(t=>t.id==fid)?.name || "";

        const projData = {
            id: (id === "NEW") ? Date.now() : Number(id),
            name, value: val, status, foremanId: fid, foremanName, start, end, address: addr,
            expenses: (id !== "NEW") ? (db.projects.find(p=>p.id==id)?.expenses || []) : []
        };

        // Save to array then cloud
        if(id === "NEW") db.projects.push(projData);
        else {
            const idx = db.projects.findIndex(x=>x.id==id);
            if(idx !== -1) db.projects[idx] = projData;
        }

        saveToCloud();
        closeModals();
        notify("Job Saved Successfully");
    }

    function renderProjects(filter="") {
        const list = document.getElementById('projectList'); list.innerHTML="";
        db.projects.filter(p=>p.name.toLowerCase().includes(filter.toLowerCase())).forEach(p => {
            list.innerHTML += `
                <div class="list-item">
                    <div style="flex:1">
                        <span class="badge badge-${p.status}">${p.status}</span>
                        <div style="font-weight:bold; font-size:1.1rem; margin-top:5px;">${p.name}</div>
                        <div style="font-size:0.85rem; color:#64748b"><i class="fas fa-map-marker-alt"></i> ${p.address || 'No Address'}</div>
                        <div style="font-size:0.85rem; color:#64748b"><i class="fas fa-calendar"></i> ${p.start || 'TBD'} -> ${p.end || 'TBD'}</div>
                    </div>
                    <div style="text-align:right; margin-right:20px;">
                        <div style="font-weight:bold; color:var(--primary);">$${p.value.toLocaleString()}</div>
                        <small>${p.foremanName || 'Unassigned'}</small>
                    </div>
                    <div>
                        <button class="btn btn-outline btn-sm" onclick="openProjectModal(${p.id})"><i class="fas fa-pen"></i></button>
                        <button class="btn btn-danger btn-sm" onclick="delProject(${p.id})"><i class="fas fa-trash"></i></button>
                    </div>
                </div>`;
        });
    }

    // --- 6. CSV IMPORT (RESTORED) ---
    function handleCSV(input) {
        const file = input.files[0];
        if(!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            const rows = e.target.result.split('\n');
            let count = 0;
            for(let i=1; i<rows.length; i++) {
                if(!rows[i].trim()) continue;
                const cols = rows[i].split(',');
                // Map CSV: Name, Value, Address, Phone
                const name = cols[1] ? cols[1].replace(/"/g,'').trim() : "Lead";
                db.projects.push({
                    id: Date.now()+i, name: name, value: 0, status: 'Lead', 
                    address: cols[4] ? cols[4].replace(/"/g,'').trim() : "",
                    expenses: []
                });
                count++;
            }
            saveToCloud();
            notify(`Imported ${count} leads from CSV`);
            input.value = "";
        };
        reader.readAsText(file);
    }

    // --- 7. UTILS & HELPERS ---
    function saveToCloud() {
        database.ref('projects').set(arrToObj(db.projects));
        database.ref('catalog').set(arrToObj(db.catalog));
        database.ref('team').set(arrToObj(db.team));
    }
    function arrToObj(arr) { const obj={}; arr.forEach(x=>obj[x.id]=x); return obj; }
    function notify(msg, type="success") {
        const t = document.createElement('div'); t.className=`toast ${type}`; t.innerHTML = msg;
        document.getElementById('toast-container').appendChild(t);
        setTimeout(()=>t.remove(), 3000);
    }
    function openMap() {
        const addr = document.getElementById('p_address').value;
        if(addr) window.open(`https://maps.google.com/?q=${addr}`, '_blank');
    }
    function nav(view, el) {
        document.querySelectorAll('.view-section').forEach(x=>x.classList.remove('active'));
        document.getElementById('view-'+view).classList.add('active');
        document.querySelectorAll('.nav-item').forEach(x=>x.classList.remove('active'));
        el.classList.add('active');
        document.getElementById('page-title').innerText = el.innerText;
        if(view === 'calendar') setTimeout(() => calendar.render(), 200); // Fix render bug
    }

    // Modal Openers
    function openProjectModal(id=null) {
        document.getElementById('modalProject').style.display='flex';
        const s = document.getElementById('p_foreman'); s.innerHTML='<option value="">-- Unassigned --</option>';
        db.team.forEach(t=>s.innerHTML+=`<option value="${t.id}">${t.name}</option>`);
        
        if(id) {
            const p = db.projects.find(x=>x.id==id);
            document.getElementById('p_id').value=p.id; document.getElementById('p_name').value=p.name;
            document.getElementById('p_val').value=p.value; document.getElementById('p_status').value=p.status;
            document.getElementById('p_foreman').value=p.foremanId||""; document.getElementById('p_address').value=p.address||"";
            document.getElementById('p_start').value=p.start||""; document.getElementById('p_end').value=p.end||"";
        } else {
            document.getElementById('p_id').value="NEW"; document.getElementById('p_name').value=""; document.getElementById('p_val').value="";
        }
    }
    function closeModals() { document.querySelectorAll('.modal-overlay').forEach(e=>e.style.display='none'); }
    
    // Dashboard
    function renderDashboard() {
        const rev = db.projects.reduce((a,b)=>a+(b.value||0),0);
        document.getElementById('kpi-rev').innerText = "$"+rev.toLocaleString();
        document.getElementById('kpi-scheduled').innerText = db.projects.filter(p=>p.status==='Scheduled').length;
        document.getElementById('kpi-done').innerText = db.projects.filter(p=>p.status==='Done').length;
        
        const ctx = document.getElementById('finChart');
        if(chart) chart.destroy();
        chart = new Chart(ctx, {
            type: 'doughnut',
            data: { labels:['Lead','Scheduled','InProgress','Done'], datasets:[{data:[
                db.projects.filter(p=>p.status==='Lead').length,
                db.projects.filter(p=>p.status==='Scheduled').length,
                db.projects.filter(p=>p.status==='InProgress').length,
                db.projects.filter(p=>p.status==='Done').length
            ], backgroundColor:['#bfdbfe','#fde68a','#d8b4fe','#bbf7d0']}] },
            options:{maintainAspectRatio:false}
        });
    }

    // Stubs for other modals (Catalog/Team) - kept simple for brevity but fully functional in logic
    function openCatalogModal() { document.getElementById('modalCatalog').style.display='flex'; document.getElementById('c_id').value="NEW"; }
    function saveCatalog() { 
        const name=document.getElementById('c_name').value; const vendor=document.getElementById('c_vendor').value; const cost=Number(document.getElementById('c_cost').value);
        db.catalog.push({id:Date.now(), name, vendor, cost}); saveToCloud(); closeModals(); notify("Item Saved");
    }
    function renderCatalog() { const l=document.getElementById('catalogList'); l.innerHTML=""; db.catalog.forEach(c=>l.innerHTML+=`<div class="list-item"><strong>${c.name}</strong> $${c.cost}</div>`); }

    function openTeamModal() { document.getElementById('modalTeam').style.display='flex'; document.getElementById('t_id').value="NEW"; }
    function saveTeam() { 
        const name=document.getElementById('t_name').value; const role=document.getElementById('t_role').value;
        db.team.push({id:Date.now(), name, role}); saveToCloud(); closeModals(); notify("Crew Saved");
    }
    function renderTeam() { const l=document.getElementById('teamList'); l.innerHTML=""; db.team.forEach(t=>l.innerHTML+=`<div class="list-item"><strong>${t.name}</strong> ${t.role}</div>`); }
    function delProject(id) { if(confirm("Delete?")) { db.projects=db.projects.filter(x=>x.id!=id); saveToCloud(); } }

</script>
</body>
</html>
